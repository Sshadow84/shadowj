#!/bin/bash

# Этот скрипт устанавливает и настраивает logrotate для автоматической очистки логов.
# logrotate — это инструмент, который помогает управлять лог-файлами, ограничивая их размер и предотвращая переполнение диска.
# Он автоматически создает архивы старых логов, сжимает их и удаляет самые старые файлы после заданного количества ротаций.
#
# В данном скрипте logrotate будет настроен на:
# 1. Ежедневную ротацию логов, что предотвращает их накопление.
# 2. Ограничение объема логов до 200 MB, удаляя старые записи, если лимит превышен.
# 3. Сжатие логов для экономии места и создание новых после ротации.
#
# Используйте этот скрипт, чтобы поддерживать контроль за лог-файлами на сервере.

confirm() {
    local prompt="$1"
    read -p "$prompt [y/n, Enter = yes]: " choice
    case "$choice" in
        ""|y|Y|yes|Yes)  # Пустой ввод или "да"
            return 0  # Подтверждение действия
            ;;
        n|N|no|No)  # Любой вариант "нет"
            return 1  # Отказ от действия
            ;;
        *)
            echo "Пожалуйста, введите y или n."
            confirm "$prompt"  # Повторный запрос, если ответ не распознан
            ;;
    esac
}

install_logrotate() {
    # Проверка и установка logrotate
    if ! command -v logrotate &> /dev/null; then
        echo "Установка logrotate..."
        sudo apt update && sudo apt install -y logrotate
    else
        echo "logrotate уже установлен."
    fi

    # Настройка конфигурации logrotate
    LOGROTATE_CONF="/etc/logrotate.d/custom_logs"
    echo "Настройка logrotate для очистки логов..."

    # Создаем или перезаписываем файл конфигурации
    sudo tee "$LOGROTATE_CONF" > /dev/null <<EOL
/var/log/*.log {
    daily                   # Ротация логов ежедневно
    rotate 7                # Хранить последние 7 файлов
    compress                # Сжимать старые файлы
    missingok               # Пропускать, если файл отсутствует
    notifempty              # Пропускать, если файл пустой
    delaycompress           # Откладывать сжатие на один день
    maxsize 200M            # Общий объем логов не более 200 MB
    create                  # Создавать новый файл после ротации
    postrotate
        systemctl reload syslog.service  # Перезапуск syslog для создания нового лога
    endscript
}
EOL

    # Сообщение об успешной настройке
    echo "logrotate настроен на ежедневную очистку логов до 200 MB."
    echo "Запуск проверки logrotate..."
    sudo logrotate -f "$LOGROTATE_CONF"

    echo "Настройка завершена."
}

echo "logrotate — это инструмент, который помогает управлять лог-файлами, ограничивая их размер и предотвращая переполнение диска.
Он автоматически создает архивы старых логов, сжимает их и удаляет самые старые файлы после заданного количества ротаций."

if confirm "Установить и настроить logrotate?"; then
    install_logrotate
else
    echo "Отменено"
fi
